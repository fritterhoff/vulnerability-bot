package bot

import (
	"fmt"

	"github.com/rs/zerolog/log"
	"github.com/spf13/viper"
	"github.com/xanzy/go-gitlab"
)

type Client struct {
	*gitlab.Client
}

func NewClient() *Client {
	log.Debug().Str("gitlab.host", viper.GetString("gitlab.host")).Msg("connecting to gitlab server")

	client, err := gitlab.NewClient(viper.GetString("gitlab.token"), gitlab.WithBaseURL(viper.GetString("gitlab.host")))

	if err != nil {
		panic("cannot create a gitlab client")
	}

	return &Client{client}
}

func (c *Client) RunMergeRequest(title string, content string, source string, target string, assign string) {

	p := viper.GetString("gitlab.project")
	list, resp, err := c.MergeRequests.ListProjectMergeRequests(p,
		&gitlab.ListProjectMergeRequestsOptions{
			SourceBranch: gitlab.String(source),
			State:        gitlab.String("opened"),
		})
	if err != nil {
		log.Fatal().Err(err).Msg("Querying for merge requests failed")
		return
	}

	assignId := 0
	if assign != "" {
		mem, _, err := c.ProjectMembers.ListAllProjectMembers(p, &gitlab.ListProjectMembersOptions{
			Query: &assign,
		})
		if err != nil {
			log.Fatal().Err(err).Msg("Querying for project member failed")
		} else {
			assignId = mem[0].ID
		}
	}
	log.Debug().Str("status", resp.Status)
	if len(list) != 0 {
		if len(list) > 1 {
			log.Warn().Msgf("Found %d merge requests matching the requested pattern", len(list))
		}
		for _, mr := range list {
			if mr.Title == title {
				options := &gitlab.UpdateMergeRequestOptions{
					Title:              gitlab.String(title),
					Description:        gitlab.String(content),
					RemoveSourceBranch: gitlab.Bool(true),
					Squash:             gitlab.Bool(true),
				}
				if assign != "" {
					options.AssigneeID = gitlab.Int(assignId)
				}
				_, _, err := c.MergeRequests.UpdateMergeRequest(p, mr.IID, options)
				if err != nil {
					log.Fatal().Err(err).
						Msg("Updating merge request failed")
				}
			} else {
				log.Fatal().Err(fmt.Errorf("existing mr for source branch %s found (title: %s)", source, mr.Title)).Msg("Creating/Updating merge request failed")
			}
		}
	} else {
		log.Info().Msg("No existing merge requests found. Creating new.")
		options := &gitlab.CreateMergeRequestOptions{
			Title:              gitlab.String(title),
			Description:        gitlab.String(content),
			SourceBranch:       gitlab.String(source),
			TargetBranch:       gitlab.String(target),
			RemoveSourceBranch: gitlab.Bool(true),
			Squash:             gitlab.Bool(true),
		}
		if assign != "" {
			options.AssigneeID = gitlab.Int(assignId)
		}
		_, _, err := c.MergeRequests.CreateMergeRequest(p, options)
		if err != nil {
			log.Fatal().Err(err).
				Msg("Creating merge request failed")
		}
	}
}
